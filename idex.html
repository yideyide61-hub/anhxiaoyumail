<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Anhxiaoyu Inbox - MailTM API</title>
<style>
  :root {
    --bg: #f4f7fb;
    --card: #ffffff;
    --accent: #2563eb;
    --accent-light: #e3edff;
    --danger: #dc2626;
    --text-dark: #111827;
    --muted: #6b7280;
  }

  body {
    margin: 0;
    font-family: "Inter", system-ui, sans-serif;
    background: var(--bg);
    color: var(--text-dark);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h1 {
    margin-top: 20px;
    font-size: 1.8rem;
    color: var(--accent);
    letter-spacing: -0.5px;
  }

  .container {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 20px;
    width: 95%;
    max-width: 1100px;
    margin: 25px auto;
  }

  .panel {
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.05);
    padding: 16px;
  }

  .email-box {
    background: var(--accent-light);
    border-radius: 12px;
    padding: 12px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .email-address {
    font-weight: 700;
    font-size: 15px;
    word-break: break-all;
    color: var(--accent);
  }

  .btn {
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }

  .btn-primary:hover {
    background: #1e4ed8;
  }

  .btn-secondary {
    background: var(--accent-light);
    color: var(--accent);
  }

  .btn-secondary:hover {
    background: #dbeafe;
  }

  .btn-danger {
    background: var(--danger);
    color: #fff;
  }

  .btn-danger:hover {
    background: #b91c1c;
  }

  .inbox {
    margin-top: 15px;
    max-height: 70vh;
    overflow-y: auto;
  }

  .message-item {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    padding: 10px;
    border-radius: 10px;
    cursor: pointer;
    border: 1px solid transparent;
  }

  .message-item:hover {
    background: var(--accent-light);
  }

  .message-avatar {
    background: var(--accent-light);
    color: var(--accent);
    width: 42px;
    height: 42px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }

  .message-meta {
    flex: 1;
    overflow: hidden;
  }

  .message-meta .from {
    font-weight: 600;
    color: var(--text-dark);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .message-meta .subject {
    color: #111;
    font-weight: 500;
    font-size: 14px;
    margin-top: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .message-meta .snippet {
    color: var(--muted);
    font-size: 13px;
    margin-top: 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .badge {
    background: var(--danger);
    color: white;
    border-radius: 999px;
    font-size: 11px;
    padding: 3px 8px;
  }

  .viewer {
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.05);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .viewer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .viewer-actions {
    display: flex;
    gap: 8px;
  }

  .viewer-body {
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px;
    min-height: 60vh;
    background: #fafafa;
  }

  iframe {
    width: 100%;
    height: 60vh;
    border: none;
    border-radius: 8px;
  }

  @media (max-width: 850px) {
    .container {
      grid-template-columns: 1fr;
    }
    .inbox {
      max-height: 40vh;
    }
  }
</style>
</head>
<body>

<h1>Anhxiaoyu Inbox</h1>
<div class="container">
  <div class="panel">
    <div class="email-box">
      <div>
        <div style="font-size:12px;color:var(--muted)">Your Temp Email</div>
        <div class="email-address" id="emailAddress">Generating...</div>
      </div>
      <button class="btn btn-primary" id="copyBtn">Copy</button>
    </div>

    <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;">
      <button class="btn btn-secondary" id="refreshBtn">Refresh</button>
      <button class="btn btn-secondary" id="newBtn">New Email</button>
    </div>

    <div class="inbox" id="inbox">Loading...</div>
  </div>

  <div class="viewer">
    <div class="viewer-header">
      <div>
        <h3 id="msgSubject" style="margin:0;">No Message Selected</h3>
        <div id="msgFrom" style="font-size:13px;color:var(--muted)">Select a message to view</div>
      </div>
      <div class="viewer-actions">
        <button class="btn btn-secondary" id="copyLinkBtn" style="display:none;">Copy Link</button>
        <button class="btn btn-danger" id="deleteBtn" style="display:none;">Delete</button>
      </div>
    </div>
    <div class="viewer-body" id="viewerBody">No message content.</div>
  </div>
</div>

<script>
const BASE_URL = "https://api.mail.tm";
let token = "";
let address = "";
let password = "";
let messages = {};
let selectedId = null;

async function createAccount() {
  const random = Math.random().toString(36).substring(2, 10);
  address = `${random}@mail.tm`;
  password = "temp" + random;
  document.getElementById("emailAddress").innerText = address;

  try {
    await fetch(`${BASE_URL}/accounts`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ address, password }),
    });
  } catch (e) {
    console.warn("Account may already exist, continuing...");
  }

  const tokenRes = await fetch(`${BASE_URL}/token`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ address, password }),
  });
  const tokenData = await tokenRes.json();
  token = tokenData.token;
  fetchMessages();
  setInterval(fetchMessages, 8000);
}

async function fetchMessages() {
  const res = await fetch(`${BASE_URL}/messages`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  const data = await res.json();
  const list = data["hydra:member"];
  const inbox = document.getElementById("inbox");
  inbox.innerHTML = "";

  if (list.length === 0) {
    inbox.innerHTML = "<p style='color:var(--muted);'>No new messages yet...</p>";
    return;
  }

  list.forEach((msg) => {
    messages[msg.id] = msg;
    const div = document.createElement("div");
    div.className = "message-item";
    div.onclick = () => openMessage(msg.id);
    div.innerHTML = `
      <div class="message-avatar">${msg.from.address[0].toUpperCase()}</div>
      <div class="message-meta">
        <div class="from">${msg.from.address}</div>
        <div class="subject">${msg.subject || "(No Subject)"}</div>
        <div class="snippet">${msg.intro || ""}</div>
      </div>
      ${msg.seen ? "" : '<span class="badge">NEW</span>'}
    `;
    inbox.appendChild(div);
  });
}

async function openMessage(id) {
  selectedId = id;
  const msgRes = await fetch(`${BASE_URL}/messages/${id}`, {
    headers: { Authorization: `Bearer ${token}` },
  });
  const msg = await msgRes.json();
  messages[id] = msg;

  document.getElementById("msgSubject").innerText = msg.subject || "(No Subject)";
  document.getElementById("msgFrom").innerText = `From: ${msg.from.address}`;
  document.getElementById("copyLinkBtn").style.display = "inline-block";
  document.getElementById("deleteBtn").style.display = "inline-block";

  const body = document.getElementById("viewerBody");
  if (msg.html) {
    body.innerHTML = `<iframe sandbox srcdoc="${msg.html.replace(/"/g, "&quot;")}"></iframe>`;
  } else {
    body.innerHTML = `<pre>${msg.text || "(No Content)"}</pre>`;
  }
}

document.getElementById("copyBtn").addEventListener("click", () => {
  navigator.clipboard.writeText(address);
  alert("Copied to clipboard!");
});

document.getElementById("refreshBtn").addEventListener("click", fetchMessages);

document.getElementById("newBtn").addEventListener("click", () => {
  location.reload();
});

document.getElementById("deleteBtn").addEventListener("click", async () => {
  if (!selectedId) return alert("No message selected.");
  if (!confirm("Delete this message permanently?")) return;
  await fetch(`${BASE_URL}/messages/${selectedId}`, {
    method: "DELETE",
    headers: { Authorization: `Bearer ${token}` },
  });
  alert("Message deleted!");
  fetchMessages();
  document.getElementById("viewerBody").innerHTML = "Message deleted.";
  document.getElementById("msgSubject").innerText = "Deleted";
});

document.getElementById("copyLinkBtn").addEventListener("click", () => {
  if (!selectedId) return;
  const msgUrl = `${BASE_URL}/messages/${selectedId}`;
  navigator.clipboard.writeText(msgUrl);
  alert("Message API link copied!");
});

createAccount();
</script>

</body>
</html>

